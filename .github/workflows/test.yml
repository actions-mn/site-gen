name: Build and Test

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref_name }}'
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Action YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - run: |
          sudo apt-get install yamllint
          yamllint action.yml

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Format check
        run: npm run format-check

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm test

      - name: Verify dist integrity
        run: |
          if [ "$(git diff --ignore-space-at-eol dist/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build"
            git diff
            exit 1
          fi

  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, macos-15, macos-15-intel, macos-26, windows-2022, windows-2025]
    runs-on: ${{ matrix.os }}
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Checkout test data
        uses: actions/checkout@v6
        with:
          repository: metanorma/mn-samples-cc
          path: cc

      - name: Setup Metanorma
        uses: actions-mn/setup@v3

      - name: Test basic parameters
        uses: ./
        with:
          source-path: cc
          config-file: metanorma.yml
          agree-to-terms: true

      - name: Verify output files
        shell: bash
        run: |
          if [ ! -f "cc/_site/index.html" ]; then
            echo "Error: Output file not created"
            exit 1
          fi
          echo "Output directory contents:"
          ls -la cc/_site/

  test-advanced:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        include:
          - os: ubuntu-latest
            install-fonts: true
            continue-without-fonts: false
            strict: true
            progress: true
          - os: ubuntu-latest
            install-fonts: false
            continue-without-fonts: true
            strict: false
            progress: false
    runs-on: ${{ matrix.os }}
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Checkout test data
        uses: actions/checkout@v6
        with:
          repository: metanorma/mn-samples-cc
          path: cc

      - name: Setup Metanorma
        uses: actions-mn/setup@v3

      - name: Test with advanced parameters
        id: test-action
        uses: ./
        with:
          source-path: cc
          output-dir: custom-site
          config-file: metanorma.yml
          agree-to-terms: true
          install-fonts: ${{ matrix.install-fonts }}
          continue-without-fonts: ${{ matrix.continue-without-fonts }}
          strict: ${{ matrix.strict }}
          progress: ${{ matrix.progress }}

      - name: Verify outputs are set
        shell: bash
        run: |
          echo "Site path: ${{ steps.test-action.outputs.site-path }}"
          echo "Config used: ${{ steps.test-action.outputs.config-used }}"
          echo "Metanorma version: ${{ steps.test-action.outputs.metanorma-version }}"

          if [ -z "${{ steps.test-action.outputs.site-path }}" ]; then
            echo "Error: site-path output not set"
            exit 1
          fi
          if [ -z "${{ steps.test-action.outputs.config-used }}" ]; then
            echo "Error: config-used output not set"
            exit 1
          fi
          if [ -z "${{ steps.test-action.outputs.metanorma-version }}" ]; then
            echo "Error: metanorma-version output not set"
            exit 1
          fi

      - name: Verify custom output directory
        uses: andstor/file-existence-action@v3
        with:
          files: cc/custom-site/index.html

  test-docker:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
        - image: metanorma/metanorma:latest
          install-fonts: false
          continue-without-fonts: true
        - image: metanorma/metanorma:latest
          install-fonts: true
          continue-without-fonts: false

    container:
      image: ${{ matrix.image }}

    steps:
      - uses: actions/checkout@v6

      - name: Checkout test data
        uses: actions/checkout@v6
        with:
          repository: metanorma/mn-samples-cc
          path: cc

      - name: Test in container
        uses: ./
        with:
          source-path: cc
          agree-to-terms: true
          install-fonts: ${{ matrix.install-fonts }}
          continue-without-fonts: ${{ matrix.continue-without-fonts }}

      - name: Verify output
        uses: andstor/file-existence-action@v3
        with:
          files: cc/_site/index.html

  test-input-validation:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v6

      - name: Test path traversal rejection
        uses: ./
        id: test-traversal
        continue-on-error: true
        with:
          source-path: '../../../etc'
          agree-to-terms: true

      - name: Verify path traversal was rejected
        shell: bash
        run: |
          if [ "${{ steps.test-traversal.outcome }}" != "failure" ]; then
            echo "Error: Path traversal should have been rejected"
            exit 1
          fi

      - name: Test invalid filename rejection
        uses: ./
        id: test-filename
        continue-on-error: true
        with:
          config-file: 'config;ls'
          agree-to-terms: true

      - name: Verify invalid filename was rejected
        shell: bash
        run: |
          if [ "${{ steps.test-filename.outcome }}" != "failure" ]; then
            echo "Error: Invalid filename should have been rejected"
            exit 1
          fi

  test-timestamps:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v6

      - name: Checkout test data
        uses: actions/checkout@v6
        with:
          repository: metanorma/mn-samples-cc
          path: cc

      - name: Setup Metanorma
        uses: actions-mn/setup@v3

      - name: Test with timestamps
        id: test-timestamps
        uses: ./
        with:
          source-path: cc
          config-file: metanorma.yml
          agree-to-terms: true
          timestamps: true

      - name: Verify outputs are set
        shell: bash
        run: |
          echo "Site path: ${{ steps.test-timestamps.outputs.site-path }}"
          echo "Config used: ${{ steps.test-timestamps.outputs.config-used }}"
          echo "Metanorma version: ${{ steps.test-timestamps.outputs.metanorma-version }}"

      - name: Verify METANORMA_CMD is exported
        shell: bash
        run: |
          if [ -z "${{ env.METANORMA_CMD }}" ]; then
            echo "Error: METANORMA_CMD not exported to GITHUB_ENV"
            exit 1
          fi
          echo "METANORMA_CMD: ${{ env.METANORMA_CMD }}"

      - name: Verify METANORMA_FLAGS is exported
        shell: bash
        run: |
          if [ -z "${{ env.METANORMA_FLAGS }}" ]; then
            echo "Error: METANORMA_FLAGS not exported to GITHUB_ENV"
            exit 1
          fi
          echo "METANORMA_FLAGS: ${{ env.METANORMA_FLAGS }}"
